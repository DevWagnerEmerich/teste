<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Acad√™mico Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 50px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 400px;
            width: 100%;
            animation: slideUp 0.8s ease-out;
        }

        .login-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 16px;
        }

        .login-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 150px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .qr-scanner {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 15px;
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: white;
            font-size: clamp(20px, 4vw, 28px);
            font-weight: 700;
        }

        .header-info {
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .coins {
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
             box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }


        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }


        .activity-item {
            background: rgba(248, 249, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .activity-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .activity-coins {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .activity-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-validated { background: #d1ecf1; color: #0c5460; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }


        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.5s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .close-btn:hover {
            color: #333;
        }


        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .qr-code-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            word-break: break-all;
        }
        .qr-code-display h4 { margin-bottom: 10px; }

        .gift-card {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .gift-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .gift-image {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            margin-right: 20px;
        }

        .gift-info {
            flex: 1;
        }

        .gift-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .gift-price {
            color: #667eea; /* Alterado para combinar com o tema */
            font-weight: 600;
            margin-bottom: 5px;
        }
        .gift-price::before {
            content: "üí∞ ";
        }


        .gift-stock {
            color: #666;
            font-size: 14px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .login-card { padding: 30px 20px; }
            .header { text-align: center; }
            .header-info { justify-content: center; margin-top: 15px; }
            .cards-grid { grid-template-columns: 1fr; }
            .gift-card { flex-direction: column; text-align: center; }
            .gift-image { margin: 0 auto 15px; }
            .activity-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 class="login-title">üéì Sistema Acad√™mico</h1>
            <p class="login-subtitle">Escolha seu tipo de acesso</p>
            
            <button class="login-btn" onclick="loginAs('admin')">
                üë®‚Äçüíº Administrador
            </button>
            
            <button class="login-btn" onclick="showQRScanner()">
                üì± Aluno (QR Code)
            </button>
            
            <div id="qrScanner" class="qr-scanner">
                <h3>üì∑ Escaneie seu QR Code</h3>
                <p>Posicione o QR Code na frente da c√¢mera</p>
                <button class="btn" onclick="simulateQRScan()">üîç Simular Scan (Aluno Jo√£o)</button>
            </div>
        </div>
    </div>

    <div id="systemInterface" class="container hidden">
        <header class="header">
            <h1 id="headerTitle">üéì Dashboard</h1>
            <div class="header-info">
                <div id="userInfo"></div>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
        </header>

        <nav class="nav-tabs" id="navTabs">
            </nav>

        <div id="tabsContent">
            </div>
    </div>

    <div id="modal" class="modal" onclick="closeModalOutside(event)">
        <div class="modal-content" id="modalInnerContent" onclick="event.stopPropagation()">
            </div>
    </div>

    <script>
        // Dados do sistema (simulando banco de dados)
        let systemData = {
            students: [
                { id: 1, name: "Jo√£o Silva", email: "joao@email.com", coins: 150, qrCode: "QR001JOAO" },
                { id: 2, name: "Maria Santos", email: "maria@email.com", coins: 200, qrCode: "QR002MARIA" }
            ],
            activities: [
                { id: 1, title: "Leitura do Cap√≠tulo 1", description: "Ler e resumir o primeiro cap√≠tulo do livro de matem√°tica.", coins: 20, studentId: 1, status: "pending" }, // pending, completed, validated
                { id: 2, title: "Exerc√≠cios de F√≠sica", description: "Resolver os exerc√≠cios 1-10 da p√°gina 45.", coins: 30, studentId: 1, status: "completed" },
                { id: 3, title: "Apresenta√ß√£o de Hist√≥ria", description: "Preparar slides sobre a Revolu√ß√£o Francesa.", coins: 50, studentId: 2, status: "pending" }
            ],
            gifts: [
                { id: 1, name: "Caneta Premium", price: 50, stock: 10, image: "üñäÔ∏è" },
                { id: 2, name: "Caderno Personalizado", price: 100, stock: 5, image: "üìì" }
            ],
            redeemRequests: [
                // { id: 1, studentId: 1, studentName: "Jo√£o Silva", giftId: 1, giftName: "Caneta Premium", status: "pending", date: new Date() }
            ],
            currentUser: null,
            userType: null,
            nextStudentId: 3,
            nextActivityId: 4,
            nextGiftId: 3,
            nextRedeemRequestId: 1
        };

        // Vari√°vel global para armazenar as fun√ß√µes das tabs
        window.tabFunctions = {};

        // ========== FUN√á√ïES DE LOGIN E LOGOUT ==========
        function loginAs(type) {
            console.log(" Iniciando loginAs para o tipo:", type);
            systemData.userType = type;
            if (type === 'admin') {
                systemData.currentUser = { id: 0, name: "Administrador", isAdmin: true };
                console.log(" Usu√°rio admin definido. Chamando showAdminInterface...");
                showAdminInterface();
            }
            
            const loginScreen = document.getElementById('loginScreen');
            const systemInterface = document.getElementById('systemInterface');

            if (loginScreen && systemInterface) {
                loginScreen.classList.add('hidden');
                systemInterface.classList.remove('hidden');
                console.log(" Telas de login/interface do sistema deveriam ter sido alternadas.");
            } else {
                console.error(" ERRO: Elemento loginScreen ou systemInterface n√£o encontrado!");
            }
        }

        function showQRScanner() {
            console.log(" Iniciando showQRScanner.");
            const qrScannerDiv = document.getElementById('qrScanner');
            if (qrScannerDiv) {
                qrScannerDiv.style.display = 'block';
                console.log(" Scanner QR deve estar vis√≠vel agora.");
            } else {
                console.error(" ERRO: Elemento qrScanner n√£o encontrado!");
            }
        }

        function simulateQRScan() {
            console.log(" Iniciando simulateQRScan.");
            // Simula o scan de QR code do primeiro aluno (Jo√£o Silva)
            const student = systemData.students.find(s => s.id === 1); 
            if (student) {
                systemData.currentUser = student;
                systemData.userType = 'student';
                console.log(" Usu√°rio aluno definido:", student.name, ". Chamando showStudentInterface...");
                showStudentInterface();

                const loginScreen = document.getElementById('loginScreen');
                const systemInterface = document.getElementById('systemInterface');

                if (loginScreen && systemInterface) {
                    loginScreen.classList.add('hidden');
                    systemInterface.classList.remove('hidden');
                    console.log(" Telas de login/interface do sistema deveriam ter sido alternadas para aluno.");
                } else {
                    console.error(" ERRO: Elemento loginScreen ou systemInterface n√£o encontrado ao logar aluno!");
                }
            } else {
                console.error(" ERRO: Aluno com ID 1 n√£o encontrado para simular scan!");
                alert("Erro: Aluno de simula√ß√£o n√£o encontrado.")
            }
        }

        function logout() {
            console.log("Iniciando logout...");
            systemData.currentUser = null;
            systemData.userType = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('systemInterface').classList.add('hidden');
            document.getElementById('qrScanner').style.display = 'none';
            document.getElementById('navTabs').innerHTML = ''; 
            document.getElementById('tabsContent').innerHTML = ''; 
            window.tabFunctions = {}; 
            console.log("Logout realizado. Interface limpa.");
        }

        // ========== RENDERIZA√á√ÉO DE INTERFACES GERAIS ==========
        function showAdminInterface() {
            console.log(" Iniciando showAdminInterface.");
            document.getElementById('headerTitle').textContent = 'üë®‚Äçüíº Dashboard Administrador';
            document.getElementById('userInfo').innerHTML = `<span>Bem-vindo, ${systemData.currentUser.name}!</span>`;

            const tabs = [
                { id: 'students', title: 'üë• Alunos', content: renderStudentsTab },
                { id: 'activities', title: 'üìã Atividades', content: renderActivitiesTab },
                { id: 'gifts', title: 'üéÅ Brindes', content: renderGiftsTab },
                { id: 'requests', title: 'üîî Solicita√ß√µes', content: renderRequestsTab },
                { id: 'performance', title: 'üìä Performance', content: renderPerformanceTab }
            ];
            console.log(" Tabs do admin definidas. Chamando renderTabs...");
            renderTabs(tabs);
            console.log(" Chamando showTab('students') para admin.");
            showTab('students');
        }

        function showStudentInterface() {
            console.log(" Iniciando showStudentInterface.");
            const student = systemData.currentUser;
            if (!student) {
                console.error(" ERRO: showStudentInterface chamada sem currentUser (aluno).");
                logout(); // Volta para tela de login se n√£o houver aluno
                return;
            }
            document.getElementById('headerTitle').textContent = 'üéì Meu Dashboard';
            document.getElementById('userInfo').innerHTML = `
                <span>Ol√°, ${student.name}!</span>
                <div class="coins">üí∞ ${student.coins} coins</div>`;

            const tabs = [
                { id: 'myActivities', title: 'üéØ Minhas Atividades', content: renderMyActivitiesTab },
                { id: 'store', title: 'üõí Loja de Brindes', content: renderStoreTab },
                { id: 'myRequests', title: 'üìú Meus Pedidos', content: renderMyRequestsTab },
                { id: 'profile', title: 'üë§ Meu Perfil', content: renderProfileTab }
            ];
            console.log(" Tabs do aluno definidas. Chamando renderTabs...");
            renderTabs(tabs);
            console.log(" Chamando showTab('myActivities') para aluno.");
            showTab('myActivities');
        }
        
        // ========== SISTEMA DE ABAS (TABS) ==========
        function renderTabs(tabs) {
            console.log(" Iniciando renderTabs com:", tabs.map(t => t.id).join(', '));
            const navTabs = document.getElementById('navTabs');
            const tabsContent = document.getElementById('tabsContent');

            if (!navTabs || !tabsContent) {
                console.error(" ERRO: Elementos navTabs ou tabsContent n√£o encontrados!");
                return;
            }

            navTabs.innerHTML = tabs.map(tab => 
                `<button class="nav-tab" onclick="showTab('${tab.id}')">${tab.title}</button>`
            ).join('');

            tabsContent.innerHTML = tabs.map(tab => 
                `<div id="${tab.id}" class="tab-content"></div>`
            ).join('');

            window.tabFunctions = {};
            tabs.forEach(tab => {
                window.tabFunctions[tab.id] = tab.content;
            });
            console.log(" Fun√ß√µes das tabs armazenadas em window.tabFunctions.");
        }

        function showTab(tabId) {
            console.log(" Iniciando showTab para tabId:", tabId);
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const targetTabButton = document.querySelector(`.nav-tab[onclick="showTab('${tabId}')"]`);
            if (targetTabButton) {
                targetTabButton.classList.add('active');
            } else {
                console.warn(" AVISO: Bot√£o da tab n√£o encontrado para:", tabId);
            }
            
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            } else {
                console.warn(" AVISO: Elemento de conte√∫do da tab n√£o encontrado para:", tabId);
                return; 
            }

            if (window.tabFunctions && typeof window.tabFunctions[tabId] === 'function') {
                console.log(" Renderizando conte√∫do para tabId:", tabId);
                try {
                    targetContent.innerHTML = window.tabFunctions[tabId]();
                } catch (e) {
                    console.error(` ERRO ao renderizar conte√∫do da tab "${tabId}":`, e);
                    targetContent.innerHTML = `<p style="color: red; font-weight: bold;">Erro ao carregar conte√∫do da aba "${tabId}". Verifique o console.</p>`;
                }
            } else {
                console.warn(` AVISO: Fun√ß√£o de renderiza√ß√£o n√£o encontrada para tabId: "${tabId}".`);
                targetContent.innerHTML = `<p>Conte√∫do para ${tabId} n√£o implementado ou fun√ß√£o de renderiza√ß√£o ausente.</p>`;
            }
        }

        function refreshCurrentTab() {
            const activeTabButton = document.querySelector('.nav-tab.active');
            if (activeTabButton) {
                const activeTabId = activeTabButton.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (activeTabId) {
                    console.log("Atualizando aba:", activeTabId);
                    showTab(activeTabId);
                }
            } else {
                console.warn("Nenhuma aba ativa encontrada para atualizar.");
            }
        }
        
        // ========== MODAL ==========
        function openModal(title, contentHtml) {
            console.log("Abrindo modal com t√≠tulo:", title);
            const modal = document.getElementById('modal');
            const modalInnerContent = document.getElementById('modalInnerContent');
            
            modalInnerContent.innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                ${contentHtml}
            `;
            modal.classList.add('active');
        }

        function closeModal() {
            console.log("Fechando modal.");
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            document.getElementById('modalInnerContent').innerHTML = ''; // Limpa o conte√∫do
        }

        function closeModalOutside(event) {
            if (event.target.id === 'modal') {
                closeModal();
            }
        }

        // ========== ADMIN: ALUNOS ==========
        function renderStudentsTab() {
            console.log("Renderizando aba de Alunos (Admin)");
            return `
                <div class="cards-grid">
                    <div class="card">
                        <h3 class="card-title">‚ûï Adicionar Novo Aluno</h3>
                        <button class="btn" onclick="showAddStudentModal()">Adicionar Aluno</button>
                    </div>
                </div>
                <div class="cards-grid">
                    ${systemData.students.map(student => `
                        <div class="card">
                            <h3 class="card-title">${student.name}</h3>
                            <p><strong>ID:</strong> ${student.id}</p>
                            <p><strong>Email:</strong> ${student.email}</p>
                            <p><strong>Coins:</strong> ${student.coins}</p>
                            <p><strong>QR Code:</strong> ${student.qrCode}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="showStudentQRCodeModal('${student.name}', '${student.qrCode}')">Ver QR Code</button>
                                <button class="btn btn-secondary" onclick="showEditStudentModal(${student.id})">Editar</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showAddStudentModal() {
            const formHtml = `
                <form onsubmit="addStudent(event)">
                    <div class="form-group">
                        <label for="studentName" class="form-label">Nome do Aluno:</label>
                        <input type="text" id="studentName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="studentEmail" class="form-label">Email:</label>
                        <input type="email" id="studentEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="studentCoins" class="form-label">Coins Iniciais:</label>
                        <input type="number" id="studentCoins" class="form-input" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="studentQrCode" class="form-label">QR Code (√∫nico):</label>
                        <input type="text" id="studentQrCode" class="form-input" value="QR${Date.now()}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Salvar Aluno</button>
                </form>
            `;
            openModal("Adicionar Novo Aluno", formHtml);
        }

        function addStudent(event) {
            event.preventDefault();
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;
            const coins = parseInt(document.getElementById('studentCoins').value);
            const qrCode = document.getElementById('studentQrCode').value;

            if (systemData.students.some(s => s.qrCode === qrCode || s.email === email)) {
                alert("Erro: QR Code ou Email j√° existem para outro aluno.");
                return;
            }

            const newStudent = { id: systemData.nextStudentId++, name, email, coins, qrCode };
            systemData.students.push(newStudent);
            console.log("Aluno adicionado:", newStudent);
            alert("Aluno adicionado com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function showEditStudentModal(studentId) {
            const student = systemData.students.find(s => s.id === studentId);
            if (!student) {
                alert("Aluno n√£o encontrado!");
                return;
            }
            const formHtml = `
                <form onsubmit="updateStudent(event, ${studentId})">
                    <div class="form-group">
                        <label for="editStudentName" class="form-label">Nome do Aluno:</label>
                        <input type="text" id="editStudentName" class="form-input" value="${student.name}" required>
                    </div>
                    <div class="form-group">
                        <label for="editStudentEmail" class="form-label">Email:</label>
                        <input type="email" id="editStudentEmail" class="form-input" value="${student.email}" required>
                    </div>
                    <div class="form-group">
                        <label for="editStudentCoins" class="form-label">Coins:</label>
                        <input type="number" id="editStudentCoins" class="form-input" value="${student.coins}" min="0" required>
                    </div>
                     <div class="form-group">
                        <label for="editStudentQrCode" class="form-label">QR Code:</label>
                        <input type="text" id="editStudentQrCode" class="form-input" value="${student.qrCode}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Atualizar Aluno</button>
                </form>
            `;
            openModal(`Editar Aluno: ${student.name}`, formHtml);
        }
        
        function updateStudent(event, studentId) {
            event.preventDefault();
            const studentIndex = systemData.students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) {
                alert("Aluno n√£o encontrado para atualiza√ß√£o!");
                return;
            }
            const name = document.getElementById('editStudentName').value;
            const email = document.getElementById('editStudentEmail').value;
            const coins = parseInt(document.getElementById('editStudentCoins').value);
            const qrCode = document.getElementById('editStudentQrCode').value;

            // Verifica se o novo email ou QR Code j√° existe em OUTRO aluno
            if (systemData.students.some(s => s.id !== studentId && (s.email === email || s.qrCode === qrCode))) {
                alert("Erro: Novo Email ou QR Code j√° est√° em uso por outro aluno.");
                return;
            }

            systemData.students[studentIndex] = { ...systemData.students[studentIndex], name, email, coins, qrCode };
            console.log("Aluno atualizado:", systemData.students[studentIndex]);
            alert("Aluno atualizado com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function showStudentQRCodeModal(studentName, qrCode) {
            const qrHtml = `
                <div class="qr-code-display">
                    <h4>QR Code de ${studentName}</h4>
                    <p><code>${qrCode}</code></p>
                    <p style="margin-top:10px; font-size: 0.9em;">Em um sistema real, aqui seria exibida uma imagem de QR Code.</p>
                </div>
            `;
            openModal(`QR Code: ${studentName}`, qrHtml);
        }

        // ========== ADMIN: ATIVIDADES ==========
        function renderActivitiesTab() {
            console.log("Renderizando aba de Atividades (Admin)");
            return `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 class="card-title">‚ûï Nova Atividade Global</h3>
                    <button class="btn" onclick="showAddActivityModal()">Criar Atividade</button>
                </div>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-number">${systemData.activities.filter(a => a.status === 'pending').length}</div><div class="stat-label">Pendentes</div></div>
                    <div class="stat-card"><div class="stat-number">${systemData.activities.filter(a => a.status === 'completed').length}</div><div class="stat-label">Aguardando Valida√ß√£o</div></div>
                    <div class="stat-card"><div class="stat-number">${systemData.activities.filter(a => a.status === 'validated').length}</div><div class="stat-label">Validadas</div></div>
                </div>
                ${systemData.activities.map(activity => {
                    const student = systemData.students.find(s => s.id === activity.studentId);
                    let statusText = 'Pendente';
                    if (activity.status === 'completed') statusText = 'Conclu√≠da (Aguardando Valida√ß√£o)';
                    if (activity.status === 'validated') statusText = 'Validada';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-header">
                                <div class="activity-title">${activity.title} (ID: ${activity.id})</div>
                                <div class="activity-coins">üí∞ ${activity.coins} coins</div>
                            </div>
                            <div class="activity-description">${activity.description}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <span class="status-badge status-${activity.status}">${statusText}</span>
                                    <span style="margin-left: 10px; color: #666;">Aluno: ${student ? student.name : 'Global / N√£o Atribu√≠da'}</span>
                                </div>
                                <div>
                                    ${activity.status === 'completed' && student ? `<button class="btn btn-success" onclick="validateActivity(${activity.id})">‚úÖ Validar</button>` : ''}
                                    <button class="btn btn-secondary" onclick="showEditActivityModal(${activity.id})">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger" onclick="deleteActivity(${activity.id})">üóëÔ∏è Excluir</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function showAddActivityModal() {
            const studentOptions = systemData.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const formHtml = `
                <form onsubmit="addActivity(event)">
                    <div class="form-group">
                        <label for="activityTitle" class="form-label">T√≠tulo:</label>
                        <input type="text" id="activityTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="activityDescription" class="form-label">Descri√ß√£o:</label>
                        <textarea id="activityDescription" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="activityCoins" class="form-label">Coins:</label>
                        <input type="number" id="activityCoins" class="form-input" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="activityStudentId" class="form-label">Atribuir ao Aluno (Opcional):</label>
                        <select id="activityStudentId" class="form-select">
                            <option value="">Nenhum (Atividade Global)</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Criar Atividade</button>
                </form>
            `;
            openModal("Criar Nova Atividade", formHtml);
        }

        function addActivity(event) {
            event.preventDefault();
            const title = document.getElementById('activityTitle').value;
            const description = document.getElementById('activityDescription').value;
            const coins = parseInt(document.getElementById('activityCoins').value);
            const studentIdValue = document.getElementById('activityStudentId').value;
            const studentId = studentIdValue ? parseInt(studentIdValue) : null;

            const newActivity = { id: systemData.nextActivityId++, title, description, coins, studentId, status: 'pending' };
            systemData.activities.push(newActivity);
            console.log("Atividade adicionada:", newActivity);
            alert("Atividade criada com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function showEditActivityModal(activityId) {
            const activity = systemData.activities.find(a => a.id === activityId);
            if (!activity) {
                alert("Atividade n√£o encontrada!");
                return;
            }
            const studentOptions = systemData.students.map(s => 
                `<option value="${s.id}" ${activity.studentId === s.id ? 'selected' : ''}>${s.name}</option>`
            ).join('');

            const formHtml = `
                <form onsubmit="updateActivity(event, ${activityId})">
                    <div class="form-group">
                        <label for="editActivityTitle" class="form-label">T√≠tulo:</label>
                        <input type="text" id="editActivityTitle" class="form-input" value="${activity.title}" required>
                    </div>
                    <div class="form-group">
                        <label for="editActivityDescription" class="form-label">Descri√ß√£o:</label>
                        <textarea id="editActivityDescription" class="form-textarea" required>${activity.description}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="editActivityCoins" class="form-label">Coins:</label>
                        <input type="number" id="editActivityCoins" class="form-input" value="${activity.coins}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editActivityStudentId" class="form-label">Atribuir ao Aluno (Opcional):</label>
                        <select id="editActivityStudentId" class="form-select">
                            <option value="" ${!activity.studentId ? 'selected' : ''}>Nenhum (Atividade Global)</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editActivityStatus" class="form-label">Status:</label>
                        <select id="editActivityStatus" class="form-select">
                            <option value="pending" ${activity.status === 'pending' ? 'selected' : ''}>Pendente</option>
                            <option value="completed" ${activity.status === 'completed' ? 'selected' : ''}>Conclu√≠da</option>
                            <option value="validated" ${activity.status === 'validated' ? 'selected' : ''}>Validada</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Atualizar Atividade</button>
                </form>
            `;
            openModal(`Editar Atividade: ${activity.title}`, formHtml);
        }

        function updateActivity(event, activityId) {
            event.preventDefault();
            const activityIndex = systemData.activities.findIndex(a => a.id === activityId);
            if (activityIndex === -1) {
                alert("Atividade n√£o encontrada para atualiza√ß√£o!");
                return;
            }
            const title = document.getElementById('editActivityTitle').value;
            const description = document.getElementById('editActivityDescription').value;
            const coins = parseInt(document.getElementById('editActivityCoins').value);
            const studentIdValue = document.getElementById('editActivityStudentId').value;
            const studentId = studentIdValue ? parseInt(studentIdValue) : null;
            const status = document.getElementById('editActivityStatus').value;
            
            systemData.activities[activityIndex] = { ...systemData.activities[activityIndex], title, description, coins, studentId, status };
            console.log("Atividade atualizada:", systemData.activities[activityIndex]);
            alert("Atividade atualizada com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function deleteActivity(activityId) {
            if (confirm("Tem certeza que deseja excluir esta atividade?")) {
                systemData.activities = systemData.activities.filter(a => a.id !== activityId);
                console.log("Atividade exclu√≠da, ID:", activityId);
                alert("Atividade exclu√≠da com sucesso!");
                refreshCurrentTab();
            }
        }

        function validateActivity(activityId) {
            const activityIndex = systemData.activities.findIndex(a => a.id === activityId);
            if (activityIndex === -1) {
                alert("Atividade n√£o encontrada!");
                return;
            }
            const activity = systemData.activities[activityIndex];
            if (activity.status !== 'completed') {
                alert("Apenas atividades conclu√≠das pelo aluno podem ser validadas.");
                return;
            }
            const studentIndex = systemData.students.findIndex(s => s.id === activity.studentId);
            if (studentIndex !== -1) {
                systemData.students[studentIndex].coins += activity.coins;
                console.log(`Coins adicionadas ao aluno ${systemData.students[studentIndex].name}: ${activity.coins}`);
            }
            systemData.activities[activityIndex].status = 'validated';
            console.log("Atividade validada:", activity);
            alert("Atividade validada e coins creditadas!");
            refreshCurrentTab();
        }
        
        // ========== ADMIN: BRINDES ==========
        function renderGiftsTab() {
            console.log("Renderizando aba de Brindes (Admin)");
            return `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 class="card-title">‚ûï Novo Brinde</h3>
                    <button class="btn" onclick="showAddGiftModal()">Adicionar Brinde</button>
                </div>
                ${systemData.gifts.map(gift => `
                    <div class="gift-card">
                        <div class="gift-image">${gift.image}</div>
                        <div class="gift-info">
                            <div class="gift-name">${gift.name} (ID: ${gift.id})</div>
                            <div class="gift-price">${gift.price} coins</div>
                            <div class="gift-stock">Estoque: ${gift.stock} unidades</div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="showEditGiftModal(${gift.id})">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger" onclick="deleteGift(${gift.id})">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function showAddGiftModal() {
            const formHtml = `
                <form onsubmit="addGift(event)">
                    <div class="form-group">
                        <label for="giftName" class="form-label">Nome do Brinde:</label>
                        <input type="text" id="giftName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="giftPrice" class="form-label">Pre√ßo (coins):</label>
                        <input type="number" id="giftPrice" class="form-input" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="giftStock" class="form-label">Estoque:</label>
                        <input type="number" id="giftStock" class="form-input" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="giftImage" class="form-label">Imagem (Emoji):</label>
                        <input type="text" id="giftImage" class="form-input" value="üéÅ" required>
                    </div>
                    <button type="submit" class="btn btn-success">Adicionar Brinde</button>
                </form>
            `;
            openModal("Adicionar Novo Brinde", formHtml);
        }

        function addGift(event) {
            event.preventDefault();
            const name = document.getElementById('giftName').value;
            const price = parseInt(document.getElementById('giftPrice').value);
            const stock = parseInt(document.getElementById('giftStock').value);
            const image = document.getElementById('giftImage').value;

            const newGift = { id: systemData.nextGiftId++, name, price, stock, image };
            systemData.gifts.push(newGift);
            console.log("Brinde adicionado:", newGift);
            alert("Brinde adicionado com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function showEditGiftModal(giftId) {
            const gift = systemData.gifts.find(g => g.id === giftId);
            if (!gift) {
                alert("Brinde n√£o encontrado!");
                return;
            }
            const formHtml = `
                <form onsubmit="updateGift(event, ${giftId})">
                    <div class="form-group">
                        <label for="editGiftName" class="form-label">Nome do Brinde:</label>
                        <input type="text" id="editGiftName" class="form-input" value="${gift.name}" required>
                    </div>
                    <div class="form-group">
                        <label for="editGiftPrice" class="form-label">Pre√ßo (coins):</label>
                        <input type="number" id="editGiftPrice" class="form-input" value="${gift.price}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editGiftStock" class="form-label">Estoque:</label>
                        <input type="number" id="editGiftStock" class="form-input" value="${gift.stock}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editGiftImage" class="form-label">Imagem (Emoji):</label>
                        <input type="text" id="editGiftImage" class="form-input" value="${gift.image}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Atualizar Brinde</button>
                </form>
            `;
            openModal(`Editar Brinde: ${gift.name}`, formHtml);
        }

        function updateGift(event, giftId) {
            event.preventDefault();
            const giftIndex = systemData.gifts.findIndex(g => g.id === giftId);
            if (giftIndex === -1) {
                alert("Brinde n√£o encontrado para atualiza√ß√£o!");
                return;
            }
            const name = document.getElementById('editGiftName').value;
            const price = parseInt(document.getElementById('editGiftPrice').value);
            const stock = parseInt(document.getElementById('editGiftStock').value);
            const image = document.getElementById('editGiftImage').value;

            systemData.gifts[giftIndex] = { ...systemData.gifts[giftIndex], name, price, stock, image };
            console.log("Brinde atualizado:", systemData.gifts[giftIndex]);
            alert("Brinde atualizado com sucesso!");
            closeModal();
            refreshCurrentTab();
        }

        function deleteGift(giftId) {
            if (confirm("Tem certeza que deseja excluir este brinde?")) {
                systemData.gifts = systemData.gifts.filter(g => g.id !== giftId);
                // Tamb√©m seria bom remover solicita√ß√µes pendentes para este brinde ou alertar.
                console.log("Brinde exclu√≠do, ID:", giftId);
                alert("Brinde exclu√≠do com sucesso!");
                refreshCurrentTab();
            }
        }

        // ========== ADMIN: SOLICITA√á√ïES DE RESGATE ==========
        function renderRequestsTab() {
            console.log("Renderizando aba de Solicita√ß√µes (Admin)");
            const pendingRequests = systemData.redeemRequests.filter(r => r.status === 'pending');
            const otherRequests = systemData.redeemRequests.filter(r => r.status !== 'pending').sort((a,b) => new Date(b.date) - new Date(a.date));


            let html = `<div class="card"><h3 class="card-title">üîî Solicita√ß√µes de Resgate Pendentes</h3>`;
            if (pendingRequests.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma solicita√ß√£o pendente.</p>';
            } else {
                html += pendingRequests.map(req => `
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-title">Resgate: ${req.giftName} (ID: ${req.id})</div>
                            <div class="activity-coins">üë§ ${req.studentName}</div>
                        </div>
                        <p>Data: ${new Date(req.date).toLocaleDateString('pt-BR')}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="approveRedeem(${req.id})">‚úÖ Aprovar</button>
                            <button class="btn btn-danger" onclick="rejectRedeem(${req.id})">‚ùå Rejeitar</button>
                        </div>
                    </div>
                `).join('');
            }
            html += `</div>`;

            html += `<div class="card" style="margin-top:30px;"><h3 class="card-title">üìú Hist√≥rico de Solicita√ß√µes</h3>`;
             if (otherRequests.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">Nenhum hist√≥rico de solicita√ß√µes.</p>';
            } else {
                html += otherRequests.map(req => {
                    let statusText = req.status === 'approved' ? 'Aprovado' : 'Rejeitado';
                    return `
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-title">Resgate: ${req.giftName} (ID: ${req.id})</div>
                             <div class="activity-coins">üë§ ${req.studentName}</div>
                        </div>
                         <p>Data: ${new Date(req.date).toLocaleDateString('pt-BR')}</p>
                         <p><span class="status-badge status-${req.status}">${statusText}</span></p>
                    </div>
                `}).join('');
            }
            html += `</div>`;
            return html;
        }
        
        function approveRedeem(requestId) {
            const requestIndex = systemData.redeemRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) {
                alert("Solicita√ß√£o n√£o encontrada!");
                return;
            }
            systemData.redeemRequests[requestIndex].status = 'approved';
            // Aqui, em um sistema real, poderia haver l√≥gicas adicionais (notificar aluno, etc.)
            console.log("Solicita√ß√£o aprovada:", systemData.redeemRequests[requestIndex]);
            alert("Solicita√ß√£o de resgate aprovada!");
            refreshCurrentTab();
        }

        function rejectRedeem(requestId) {
            const requestIndex = systemData.redeemRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) {
                alert("Solicita√ß√£o n√£o encontrada!");
                return;
            }
            const request = systemData.redeemRequests[requestIndex];
            
            // Devolver moedas e estoque
            const student = systemData.students.find(s => s.id === request.studentId);
            const gift = systemData.gifts.find(g => g.id === request.giftId);

            if (student && gift) {
                student.coins += gift.price;
                gift.stock += 1;
                systemData.redeemRequests[requestIndex].status = 'rejected';
                console.log("Solicita√ß√£o rejeitada. Moedas e estoque devolvidos:", request);
                alert("Solicita√ß√£o de resgate rejeitada. Moedas e estoque foram devolvidos.");
            } else {
                systemData.redeemRequests[requestIndex].status = 'rejected'; // Rejeita mesmo se n√£o encontrar student/gift para evitar loop
                alert("Solicita√ß√£o de resgate rejeitada. Erro ao devolver moedas/estoque (aluno/brinde n√£o encontrado).");
                 console.error("Erro ao devolver moedas/estoque: aluno ou brinde n√£o encontrado para request ID", requestId);
            }
            refreshCurrentTab();
        }

        // ========== ADMIN: PERFORMANCE ==========
        function renderPerformanceTab() {
            console.log("Renderizando aba de Performance (Admin)");
            // L√≥gica de filtro n√£o implementada, apenas exibi√ß√£o de estat√≠sticas gerais
            const totalActivities = systemData.activities.length;
            const totalCoinsDistributed = systemData.students.reduce((acc, s) => acc + s.coins, 0); // Isso √© total de coins que os alunos T√äM, n√£o necessariamente as distribu√≠das por atividades validadas.
            const validatedActivities = systemData.activities.filter(a => a.status === 'validated').length;
            const completionRate = totalActivities > 0 ? ((validatedActivities / totalActivities) * 100).toFixed(1) : 0;

            return `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 class="card-title">üìä Filtros de Performance (N√£o Implementado)</h3>
                    <p>Funcionalidade de filtros avan√ßados ainda n√£o implementada.</p>
                </div>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-number">${totalActivities}</div><div class="stat-label">Total de Atividades Criadas</div></div>
                    <div class="stat-card"><div class="stat-number">${totalCoinsDistributed}</div><div class="stat-label">Total de Coins com Alunos</div></div>
                    <div class="stat-card"><div class="stat-number">${validatedActivities}</div><div class="stat-label">Atividades Validadas</div></div>
                    <div class="stat-card"><div class="stat-number">${completionRate}%</div><div class="stat-label">Taxa de Valida√ß√£o</div></div>
                </div>
            `;
        }

        // ========== ALUNO: MINHAS ATIVIDADES ==========
        function renderMyActivitiesTab() {
            console.log("Renderizando aba Minhas Atividades (Aluno)");
            const student = systemData.currentUser;
            if (!student) return "<p>Erro: Aluno n√£o logado.</p>";

            const myActivities = systemData.activities.filter(a => a.studentId === student.id || a.studentId === null); // Inclui atividades globais
            if (myActivities.length === 0) return "<p>Voc√™ n√£o tem atividades pendentes ou dispon√≠veis no momento.</p>";

            return myActivities.map(activity => {
                let statusText = 'Pendente';
                let actions = `<button class="btn btn-success" onclick="markAsCompleted(${activity.id})">üèÅ Marcar como Conclu√≠da</button>`;
                if (activity.status === 'completed') {
                    statusText = 'Conclu√≠da (Aguardando Valida√ß√£o)';
                    actions = `<span class="status-badge status-completed">Aguardando Valida√ß√£o</span>`;
                } else if (activity.status === 'validated') {
                    statusText = 'Validada';
                    actions = `<span class="status-badge status-validated">Validada por Professor</span>`;
                }
                
                // Se a atividade √© global e o aluno j√° a completou/validou (precisaria de um log por aluno-atividade global)
                // Para simplificar, se for global e pendente, ele pode marcar.
                // Se uma atividade global foi atribu√≠da a este aluno e ele completou, ok.

                return `
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-coins">üí∞ ${activity.coins} coins</div>
                        </div>
                        <div class="activity-description">${activity.description}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span class="status-badge status-${activity.status}">${statusText}</span>
                            ${activity.status === 'pending' ? actions : (activity.status !== 'validated' ? actions : `<span class="status-badge status-validated">Validada!</span>`)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAsCompleted(activityId) {
            const student = systemData.currentUser;
            const activityIndex = systemData.activities.findIndex(a => a.id === activityId);
            if (activityIndex === -1 || !student) {
                alert("Erro ao marcar atividade. Atividade ou aluno n√£o encontrado.");
                return;
            }
            const activity = systemData.activities[activityIndex];

            // Se a atividade √© global (studentId == null), e o aluno est√° marcando,
            // precisamos criar uma "inst√¢ncia" dessa atividade para o aluno ou registrar que ele a completou.
            // Para simplicidade, vamos permitir que ele complete atividades globais,
            // mas o admin s√≥ ver√° UMA atividade global. A valida√ß√£o pelo admin que daria as moedas.
            // A melhor forma seria clonar a atividade para o aluno quando ele a inicia.

            // Se a atividade √© global e est√° sendo marcada por um aluno, associamos a ele agora.
            if (activity.studentId === null) {
                 systemData.activities[activityIndex].studentId = student.id; // Associa ao aluno que completou
            } else if (activity.studentId !== student.id) {
                alert("Esta atividade n√£o est√° atribu√≠da a voc√™.");
                return;
            }

            systemData.activities[activityIndex].status = 'completed';
            console.log(`Atividade ${activityId} marcada como conclu√≠da pelo aluno ${student.name}.`);
            alert("Atividade marcada como conclu√≠da! Aguarde a valida√ß√£o do professor.");
            refreshCurrentTab();
        }

        // ========== ALUNO: LOJA DE BRINDES ==========
        function renderStoreTab() {
            console.log("Renderizando aba Loja (Aluno)");
            const student = systemData.currentUser;
            if (!student) return "<p>Erro: Aluno n√£o logado.</p>";
            
            if (systemData.gifts.length === 0) return "<p>Nenhum brinde dispon√≠vel na loja no momento.</p>";

            return systemData.gifts.map(gift => `
                <div class="gift-card">
                    <div class="gift-image">${gift.image}</div>
                    <div class="gift-info">
                        <div class="gift-name">${gift.name}</div>
                        <div class="gift-price">${gift.price} coins</div>
                        <div class="gift-stock">Estoque: ${gift.stock > 0 ? gift.stock + ' unidades' : 'Esgotado'}</div>
                        <div style="margin-top: 10px;">
                            ${gift.stock > 0 && student.coins >= gift.price ? 
                                `<button class="btn" onclick="requestRedeem(${gift.id})">üõí Solicitar Resgate</button>` :
                                (gift.stock === 0 ? '<span style="color:red;">Esgotado</span>' : 
                                (student.coins < gift.price ? `<span style="color:orange;">Coins insuficientes</span>` : ''))
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function requestRedeem(giftId) {
            const student = systemData.currentUser;
            const gift = systemData.gifts.find(g => g.id === giftId);

            if (!student || !gift) {
                alert("Erro: Aluno ou brinde n√£o encontrado.");
                return;
            }
            if (gift.stock <= 0) {
                alert("Desculpe, este brinde est√° esgotado.");
                return;
            }
            if (student.coins < gift.price) {
                alert("Voc√™ n√£o tem coins suficientes para este brinde.");
                return;
            }

            if (confirm(`Deseja realmente solicitar o resgate de "${gift.name}" por ${gift.price} coins?`)) {
                student.coins -= gift.price;
                gift.stock -= 1;

                const newRequest = {
                    id: systemData.nextRedeemRequestId++,
                    studentId: student.id,
                    studentName: student.name,
                    giftId: gift.id,
                    giftName: gift.name,
                    status: 'pending', // pending, approved, rejected
                    date: new Date().toISOString()
                };
                systemData.redeemRequests.push(newRequest);
                console.log("Solicita√ß√£o de resgate criada:", newRequest);
                alert("Solicita√ß√£o de resgate enviada! Suas coins foram debitadas. Acompanhe em 'Meus Pedidos'.");
                
                // Atualiza as coins exibidas no header
                document.getElementById('userInfo').innerHTML = `
                    <span>Ol√°, ${student.name}!</span>
                    <div class="coins">üí∞ ${student.coins} coins</div>`;
                refreshCurrentTab(); // Atualiza a aba da loja
            }
        }
        
        // ========== ALUNO: MEUS PEDIDOS (RESGATES) ==========
        function renderMyRequestsTab() {
            console.log("Renderizando aba Meus Pedidos (Aluno)");
            const student = systemData.currentUser;
            if (!student) return "<p>Erro: Aluno n√£o logado.</p>";

            const myRequests = systemData.redeemRequests
                .filter(r => r.studentId === student.id)
                .sort((a,b) => new Date(b.date) - new Date(a.date));

            if (myRequests.length === 0) return "<p>Voc√™ ainda n√£o fez nenhuma solicita√ß√£o de resgate.</p>";

            return myRequests.map(req => {
                let statusText = 'Pendente';
                if (req.status === 'approved') statusText = 'Aprovado';
                if (req.status === 'rejected') statusText = 'Rejeitado';
                return `
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-title">Pedido de ${req.giftName}</div>
                            <span class="status-badge status-${req.status}">${statusText}</span>
                        </div>
                        <p>Data do pedido: ${new Date(req.date).toLocaleDateString('pt-BR')}</p>
                        ${req.status === 'rejected' ? '<p style="color:red;">Este pedido foi rejeitado. Suas moedas e o estoque do item foram restaurados.</p>' : ''}
                    </div>
                `;
            }).join('');
        }

        // ========== ALUNO: PERFIL ==========
        function renderProfileTab() {
            console.log("Renderizando aba Perfil (Aluno)");
            const student = systemData.currentUser;
            if (!student) return "<p>Erro: Aluno n√£o logado.</p>";
            
            return `
                <div class="card">
                    <h3 class="card-title">Informa√ß√µes do Perfil</h3>
                    <p><strong>Nome:</strong> ${student.name}</p>
                    <p><strong>Email:</strong> ${student.email}</p>
                    <p><strong>Coins Atuais:</strong> ${student.coins}</p>
                    <p><strong>Seu QR Code:</strong> <code>${student.qrCode}</code></p>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="showEditProfileModal()">‚úèÔ∏è Editar Email</button>
                        <button class="btn btn-secondary" onclick="showStudentQRCodeModal('${student.name}', '${student.qrCode}')">üì± Ver Meu QR Code</button>
                    </div>
                </div>
            `;
        }

        function showEditProfileModal() {
            const student = systemData.currentUser;
            if (!student) return;

            const formHtml = `
                <form onsubmit="updateProfile(event)">
                    <p>Nome: ${student.name} (n√£o edit√°vel aqui)</p>
                    <div class="form-group" style="margin-top:15px;">
                        <label for="profileEmail" class="form-label">Novo Email:</label>
                        <input type="email" id="profileEmail" class="form-input" value="${student.email}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Salvar Email</button>
                </form>
            `;
            openModal("Editar Email do Perfil", formHtml);
        }

        function updateProfile(event) {
            event.preventDefault();
            const student = systemData.currentUser;
            const studentIndex = systemData.students.findIndex(s => s.id === student.id);
            if (studentIndex === -1) {
                alert("Erro: Aluno n√£o encontrado.");
                return;
            }
            
            const newEmail = document.getElementById('profileEmail').value;
            // Valida√ß√£o simples de email
            if (!newEmail.includes('@')) {
                alert("Por favor, insira um email v√°lido.");
                return;
            }
            // Verifica se o novo email j√° existe em OUTRO aluno
            if (systemData.students.some(s => s.id !== student.id && s.email === newEmail)) {
                alert("Erro: Novo Email j√° est√° em uso por outro aluno.");
                return;
            }

            systemData.students[studentIndex].email = newEmail;
            systemData.currentUser.email = newEmail; // Atualiza o objeto currentUser tamb√©m

            console.log("Email do perfil atualizado para:", newEmail);
            alert("Email atualizado com sucesso!");
            closeModal();
            refreshCurrentTab(); // Atualiza a aba de perfil
        }

        // Inicializa√ß√£o (opcional, para popular dados se localStorage fosse usado, por exemplo)
        // window.onload = () => { console.log("Sistema Acad√™mico Pro Carregado."); };

    </script>
</body>
</html>